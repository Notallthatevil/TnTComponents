@page "/charts/interactivity"
@using NTComponents.Charts
@using NTComponents.Charts.Core
@using NTComponents.Charts.Core.Axes
@using NTComponents.Charts.Core.Series

<div class="container py-4">
    <h3>Chart Interactivity & Aggregation Demo</h3>
    <p class="lead">This demo showcases panning, zooming, and data aggregation for large datasets (10,000 dates).</p>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card p-3 shadow-sm h-100">
                <h5>Interactivity Instructions</h5>
                <ul>
                    <li><strong>PanX:</strong> Click and drag (Grab).</li>
                    <li><strong>ZoomX:</strong> Mouse wheel.</li>
                    <li><strong>Reset:</strong> Click the refresh button in the top right of the chart.</li>
                    <li><strong>Aggregation:</strong> When zoomed out, points are aggregated to improve performance and clarity.</li>
                </ul>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3 shadow-sm h-100">
                <h5>Aggregation Settings</h5>
                <div class="mb-2">
                    <label class="form-label">Mode</label>
                    <select class="form-select form-select-sm" @bind="_aggregationMode">
                        @foreach (var mode in Enum.GetValues<AggregationMode>()) {
                            <option value="@mode">@mode</option>
                        }
                    </select>
                </div>
                <div class="mb-2">
                    <label class="form-label">Threshold (@_aggregationThreshold points)</label>
                    <input type="range" class="form-range" min="100" max="2000" step="100" @bind="_aggregationThreshold" @bind:event="oninput" />
                </div>
                <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" @bind="_enableAggregation" id="aggCheck">
                    <label class="form-check-label" for="aggCheck">Enable Aggregation</label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" @bind="_enableHardwareAcceleration" id="hwAccelCheck">
                    <label class="form-check-label" for="hwAccelCheck">Enable Hardware Acceleration</label>
                </div>
            </div>
        </div>
    </div>

    <div class="card p-3 shadow-sm mb-4">
        <div style="height: 600px; width: 100%;">
            <NTChart TData="DataPoint" Title="High-Density Line Chart" RangePadding="0.05"
                     EnableHardwareAcceleration="@_enableHardwareAcceleration">
                <NTLineSeries TData="DataPoint"
                              Data="@data"
                              XValue="@(x => x.Time)"
                              YValueSelector="@(x => (decimal)x.Value)"
                              Title="Signal Data"
                              EnableXPan="true"
                              EnableYPan="true"
                              EnableXZoom="true"
                              EnableYZoom="true"
                              EnableAggregation="@_enableAggregation"
                              AggregationThreshold="@_aggregationThreshold"
                              AggregationMode="@_aggregationMode"
                              StrokeWidth="1.5f" />
                
                <NTXAxisOptions Title="Timeline" LabelFormat="yyyy-MM-dd" />
                <NTYAxisOptions Title="Magnitude" />
                <NTLegend TData="DataPoint" Position="LegendPosition.Bottom" />
                <NTTooltip TData="DataPoint" Enabled="true" />
            </NTChart>
        </div>
    </div>

    <div class="mt-3">
        <TnTButton OnClickCallback="@(() => ResetData())">Regenerate Data</TnTButton>
    </div>
</div>

@code {
    public record DataPoint(DateTime Time, double Value);

    private List<DataPoint> data = [];
    private bool _enableHardwareAcceleration = true;
    private bool _enableAggregation = true;
    private int _aggregationThreshold = 400;
    private AggregationMode _aggregationMode = AggregationMode.Average;

    protected override void OnInitialized()
    {
        GenerateData();
    }

    private void GenerateData()
    {
        var random = new Random();
        data = new List<DataPoint>();
        var startDate = new DateTime(2020, 1, 1);
        for (int i = 0; i < 10000; i++)
        {
            // Create a noisy sine wave
            double value = (Math.Sin(i * 0.05) * 50) + (Math.Sin(i * 0.005) * 20) + (random.NextDouble() * 10);
            data.Add(new DataPoint(startDate.AddHours(i), value));
        }
    }

    private void ResetData()
    {
        GenerateData();
        StateHasChanged();
    }
}
