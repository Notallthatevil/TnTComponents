@page "/custom-rendering"
@using NTComponents.Charts
@using NTComponents.Charts.Core
@using NTComponents.Charts.Core.Axes
@using NTComponents.Charts.Core.Series
@using SkiaSharp

<div class="container py-4">
    <h1>Advanced Data Point Rendering</h1>
    <p class="lead">Examples showing how to use the <code>OnDataPointRender</code> callback to dynamically style
        individual data points based on their values or metadata.</p>

    <div class="row">
        <!-- Conditional Bar Highlights -->
        <div class="col-md-6 mb-4">
            <div class="card p-3 shadow-sm">
                <h3>Conditional Bar Highlights</h3>
                <div style="height: 300px;">
                    <NTChart TData="SalesData" Title="Sales Performance" IsCategoricalX="true">
                        <NTBarSeries TData="SalesData" Data="@_salesPerformance" XValue="@(d => d.MonthIndex)"
                            YValueSelector="@(d => d.Units)" OnDataPointRender="@OnSalesBarRender" ShowDataLabels="true"
                            XAxis="@(new NTXAxisOptions())" YAxis="@(new NTYAxisOptions { Title = "Units" })" />
                    </NTChart>
                </div>
                <div class="mt-2 text-muted small">
                    Bars are colored <span style="color: #4CAF50; font-weight: bold;">Green</span> for targets met (&gt;
                    80)
                    and <span style="color: #F44336; font-weight: bold;">Red</span> for targets missed (&lt; 40).
                </div>
            </div>
        </div>

        <!-- Conditional Line Segments -->
        <div class="col-md-6 mb-4">
            <div class="card p-3 shadow-sm">
                <h3>Dynamic Line & Point Styling</h3>
                <div style="height: 300px;">
                    <NTChart TData="SensorReading" Title="Sensor Thresholds">
                        <NTLineSeries TData="SensorReading" Data="@_sensorReadings" XValue="@(d => d.Timestamp)"
                            YValueSelector="@(d => d.Value)" StrokeWidth="3" PointStyle="PointStyle.Filled"
                            OnDataPointRender="@OnSensorLineRender" ShowDataLabels="true"
                            XAxis="@(new NTXAxisOptions())" YAxis="@(new NTYAxisOptions { Title = "Temp °C" })" />
                    </NTChart>
                </div>
                <div class="mt-2 text-muted small">
                    Line segments and markers turn <span style="color: #FF9800; font-weight: bold;">Orange</span> and
                    become <b>Dashed</b> when readings exceed 75°C.
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-2">
        <!-- Custom Label Styling -->
        <div class="col-md-6 mb-4">
            <div class="card p-3 shadow-sm">
                <h3>Custom Label Typography</h3>
                <div style="height: 300px;">
                    <NTChart TData="MetricData" Title="Priority Focus">
                        <NTLineSeries TData="MetricData" Data="@_metricData" XValue="@(d => d.Id)"
                            YValueSelector="@(d => d.Value)" OnDataPointRender="@OnMetricLabelRender"
                            ShowDataLabels="true" XAxis="@(new NTXAxisOptions())" YAxis="@(new NTYAxisOptions())" />
                    </NTChart>
                </div>
                <div class="mt-2 text-muted small">
                    High-priority items (Value > 90) have <b>Larger, Gold</b> labels to draw attention.
                </div>
            </div>
        </div>

        <!-- Treemap Metadata Coloring -->
        <div class="col-md-6 mb-4">
            <div class="card p-3 shadow-sm">
                <h3>Metadata-Driven Treemap</h3>
                <div style="height: 300px;">
                    <NTChart TData="InventoryItem" Title="Stock by Category">
                        <NTTreeMapSeries TData="InventoryItem" Data="@_inventory" ValueSelector="@(d => d.Count)"
                            XValue="@(d => d.Name)" OnDataPointRender="@OnInventoryTreeMapRender" />
                    </NTChart>
                </div>
                <div class="mt-2 text-muted small">
                    Categories are colored by department: Electronics (Blue), Office (Grey), Furniture (Brown).
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<SalesData> _salesPerformance = new();
    private List<SensorReading> _sensorReadings = new();
    private List<MetricData> _metricData = new();
    private List<InventoryItem> _inventory = new();

    protected override void OnInitialized()
    {
        // Sample Sales Data
        _salesPerformance = Enumerable.Range(1, 12).Select(i => new SalesData
        {
            MonthIndex = i,
            Units = (decimal)Random.Shared.Next(20, 100)
        }).ToList();

        // Sample Sensor Readings
        _sensorReadings = Enumerable.Range(0, 20).Select(i => new SensorReading
        {
            Timestamp = i,
            Value = (decimal)(50 + (Math.Sin(i * 0.5) * 30) + Random.Shared.Next(-5, 5))
        }).ToList();

        // Sample Metric Data
        _metricData = Enumerable.Range(1, 10).Select(i => new MetricData
        {
            Id = i,
            Value = (decimal)Random.Shared.Next(10, 100)
        }).ToList();

        // Sample Inventory
        _inventory = new List<InventoryItem>
{
new("Laptop", 50, "Electronics"),
new("Monitor", 80, "Electronics"),
new("Keyboard", 120, "Electronics"),
new("Chair", 45, "Furniture"),
new("Desk", 30, "Furniture"),
new("Pen", 500, "Office"),
new("Paper", 300, "Office"),
new("Table", 15, "Furniture"),
new("Phone", 60, "Electronics")
};
    }

    private void OnSalesBarRender(NTDataPointRenderArgs<SalesData> args)
    {
        if (args.Data.Units >= 80)
            args.Color = args.GetThemeColor(TnTColor.Success);
        else if (args.Data.Units < 40)
            args.Color = args.GetThemeColor(TnTColor.Error);
    }

    private void OnSensorLineRender(NTDataPointRenderArgs<SensorReading> args)
    {
        if (args.Data.Value > 75)
        {
            args.Color = args.GetThemeColor(TnTColor.Warning);
            args.LineStyle = LineStyle.Dashed;
            args.PointSize = 12f;
            args.PointShape = PointShape.Diamond;
        }
    }

    private void OnMetricLabelRender(NTDataPointRenderArgs<MetricData> args)
    {
        if (args.Data.Value > 90m)
        {
            args.DataLabelColor = args.GetThemeColor(TnTColor.Tertiary);
            args.DataLabelSize = 18f;
            args.Color = args.GetThemeColor(TnTColor.Tertiary);
            args.PointSize = 12f;
        }
    }

    private void OnInventoryTreeMapRender(NTDataPointRenderArgs<InventoryItem> args)
    {
        var categoryColor = args.Data.Category switch
        {
            "Electronics" => TnTColor.Primary,
            "Office" => TnTColor.Secondary,
            "Furniture" => TnTColor.Tertiary,
            _ => TnTColor.None
        };

        if (categoryColor != TnTColor.None)
        {
            args.Color = args.GetThemeColor(categoryColor);
        }
    }

    public record SalesData { public int MonthIndex { get; set; } public decimal Units { get; set; } }
    public record SensorReading { public double Timestamp { get; set; } public decimal Value { get; set; } }
    public record MetricData { public int Id { get; set; } public decimal Value { get; set; } }
    public record InventoryItem(string Name, decimal Count, string Category);
}
